"""
Overview Page - Executive Dashboard
High-level KPIs and summary metrics across all supply chain functions
"""

import streamlit as st
import pandas as pd
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from ui_components import render_page_header, render_kpi_row, render_chart, render_info_box, render_data_table
from business_rules import CURRENCY_RULES

def calculate_overview_metrics(service_data, backorder_data, inventory_data):
    """Calculate high-level metrics for overview page"""
    metrics = {}

    # Service Level Metrics
    if not service_data.empty:
        total_orders = len(service_data)
        on_time_orders = service_data['on_time'].sum() if 'on_time' in service_data.columns else 0
        on_time_pct = (on_time_orders / total_orders * 100) if total_orders > 0 else 0

        metrics['service_level'] = {
            "value": f"{on_time_pct:.1f}%",
            "delta": None,
            "help": f"**Business Logic:** On-Time Delivery Rate = percentage of orders shipped within 7 days. Current: {on_time_pct:.1f}% ({on_time_orders:,} / {total_orders:,}). Target: 95%. Formula: (COUNT(WHERE on_time = TRUE) / COUNT(orders)) √ó 100"
        }

        metrics['total_orders'] = {
            "value": f"{total_orders:,}",
            "delta": None,
            "help": "**Business Logic:** Total count of order lines processed (shipped). Each order line is a SKU on a customer order. Formula: COUNT(order_lines)"
        }
    else:
        metrics['service_level'] = {"value": "N/A", "delta": None}
        metrics['total_orders'] = {"value": "N/A", "delta": None}

    # Backorder Metrics
    if not backorder_data.empty:
        total_backorders = backorder_data['backorder_qty'].sum() if 'backorder_qty' in backorder_data.columns else 0
        avg_days_on_bo = backorder_data['days_on_backorder'].mean() if 'days_on_backorder' in backorder_data.columns else 0

        metrics['backorders'] = {
            "value": f"{int(total_backorders):,}",
            "delta": None,
            "help": f"**Business Logic:** Total units awaiting fulfillment across all open backorders. Current: {int(total_backorders):,} units. Formula: SUM(backorder_qty WHERE backorder_qty > 0)"
        }

        metrics['avg_backorder_age'] = {
            "value": f"{avg_days_on_bo:.0f} days",
            "delta": None,
            "help": f"**Business Logic:** Average time backorders have been open. Days on Backorder = Today - Order Creation Date. Current average: {avg_days_on_bo:.1f} days. Formula: AVG(TODAY - order_date)"
        }
    else:
        metrics['backorders'] = {"value": "0", "delta": None}
        metrics['avg_backorder_age'] = {"value": "N/A", "delta": None}

    # Inventory Metrics
    if not inventory_data.empty:
        total_stock = inventory_data['on_hand_qty'].sum() if 'on_hand_qty' in inventory_data.columns else 0

        # Calculate inventory value in USD
        if 'total_value_usd' in inventory_data.columns:
            total_value_usd = inventory_data['total_value_usd'].sum()
        elif 'total_value' in inventory_data.columns:
            total_value_usd = inventory_data['total_value'].sum() * CURRENCY_CONVERSION['EUR_TO_USD']
        else:
            total_value_usd = 0

        # Calculate average DIO if available
        avg_dio = inventory_data['dio'].mean() if 'dio' in inventory_data.columns else None

        # Count critical stock situations
        critical_stock = 0
        if 'stock_risk' in inventory_data.columns:
            critical_stock = len(inventory_data[inventory_data['stock_risk'] == 'Critical'])
        elif 'dio' in inventory_data.columns:
            critical_stock = len(inventory_data[inventory_data['dio'] < 30])

        metrics['inventory_units'] = {
            "value": f"{int(total_stock):,}",
            "delta": None,
            "help": f"**Business Logic:** Total units currently on-hand across all SKUs in all warehouse locations. Current: {int(total_stock):,} units. Formula: SUM(on_hand_qty)"
        }

        metrics['inventory_value'] = {
            "value": f"${total_value_usd:,.0f}",
            "delta": None,
            "help": f"**Business Logic:** Total inventory value in USD. Calculated as: SUM(on_hand_qty √ó last_purchase_price √ó EUR_to_USD_rate). Current: ${total_value_usd:,.0f}"
        }

        if avg_dio is not None:
            metrics['avg_dio'] = {
                "value": f"{avg_dio:.0f} days",
                "delta": None,
                "help": f"**Business Logic:** Average Days Inventory Outstanding across all SKUs. Target: 60-90 days. Current: {avg_dio:.1f} days. Formula: AVG(on_hand_qty / avg_daily_demand)"
            }
        else:
            metrics['avg_dio'] = {"value": "N/A", "delta": None}

        metrics['critical_stock'] = {
            "value": f"{critical_stock:,}",
            "delta": None,
            "help": f"**Business Logic:** Count of SKUs with critical stock-out risk (DIO < 30 days). Current: {critical_stock:,} SKUs. Formula: COUNT(WHERE dio < 30)"
        }
    else:
        metrics['inventory_units'] = {"value": "N/A", "delta": None}
        metrics['inventory_value'] = {"value": "N/A", "delta": None}
        metrics['avg_dio'] = {"value": "N/A", "delta": None}
        metrics['critical_stock'] = {"value": "N/A", "delta": None}

    return metrics

def render_service_level_chart(service_data):
    """Render service level trend chart"""
    if service_data.empty or 'ship_month' not in service_data.columns:
        return None

    # Group by month
    monthly = service_data.groupby('ship_month').agg({
        'on_time': ['sum', 'count']
    }).reset_index()

    monthly.columns = ['month', 'on_time_count', 'total_count']
    monthly['on_time_pct'] = (monthly['on_time_count'] / monthly['total_count'] * 100)

    # Sort by month
    monthly = monthly.sort_values('month')

    # Create chart
    fig = go.Figure()

    fig.add_trace(go.Scatter(
        x=monthly['month'],
        y=monthly['on_time_pct'],
        mode='lines+markers',
        name='On-Time %',
        line=dict(color='#2E86AB', width=3),
        marker=dict(size=8)
    ))

    # Add target line
    fig.add_hline(y=95, line_dash="dash", line_color="green", annotation_text="Target: 95%")

    fig.update_layout(
        title="Service Level Trend",
        xaxis_title="Month",
        yaxis_title="On-Time Delivery %",
        yaxis_range=[0, 100]
    )

    return fig

def render_backorder_chart(backorder_data):
    """Render backorder trend chart"""
    if backorder_data.empty or 'days_on_backorder' not in backorder_data.columns:
        return None

    # Create aging buckets
    backorder_data['age_bucket'] = pd.cut(
        backorder_data['days_on_backorder'],
        bins=[0, 7, 14, 30, 60, float('inf')],
        labels=['0-7 days', '8-14 days', '15-30 days', '31-60 days', '60+ days']
    )

    aging = backorder_data.groupby('age_bucket', observed=True)['backorder_qty'].sum().reset_index()

    # Create chart
    fig = go.Figure()

    fig.add_trace(go.Bar(
        x=aging['age_bucket'],
        y=aging['backorder_qty'],
        marker_color=['#06D6A0', '#FFD166', '#EF8354', '#F4442E', '#A71E2C']
    ))

    fig.update_layout(
        title="Backorder Aging Analysis",
        xaxis_title="Age Bucket",
        yaxis_title="Backorder Quantity"
    )

    return fig

def render_overview_page(service_data, backorder_data, inventory_data):
    """Main overview page render function"""

    # Page header
    render_page_header(
        "Executive Overview",
        icon="üìä",
        subtitle="Key performance indicators across your end-to-end supply chain"
    )

    # Calculate metrics
    metrics = calculate_overview_metrics(service_data, backorder_data, inventory_data)

    # Render KPI rows
    st.subheader("Key Performance Indicators")

    # Row 1: Service & Order Fulfillment
    kpi_row_1 = {
        "Service Level": metrics.get('service_level', {}),
        "Total Orders": metrics.get('total_orders', {}),
        "Backorders": metrics.get('backorders', {})
    }
    render_kpi_row(kpi_row_1)

    st.divider()

    # Row 2: Inventory Health
    kpi_row_2 = {
        "Inventory Value": metrics.get('inventory_value', {}),
        "Inventory Units": metrics.get('inventory_units', {}),
        "Avg DIO": metrics.get('avg_dio', {})
    }
    render_kpi_row(kpi_row_2)

    st.divider()

    # Row 3: Alerts & Risk
    kpi_row_3 = {
        "Avg Backorder Age": metrics.get('avg_backorder_age', {}),
        "Critical Stock SKUs": metrics.get('critical_stock', {}),
        "": {"value": "", "delta": None}  # Placeholder for future metric
    }
    render_kpi_row(kpi_row_3)

    st.divider()

    # Charts section
    st.subheader("Performance Trends")

    col1, col2 = st.columns(2)

    with col1:
        service_chart = render_service_level_chart(service_data)
        if service_chart:
            render_chart(service_chart, height=350)
        else:
            render_info_box("No service level data available", type="info")

    with col2:
        backorder_chart = render_backorder_chart(backorder_data)
        if backorder_chart:
            render_chart(backorder_chart, height=350)
        else:
            render_info_box("No backorder data available", type="info")

    # Alerts and Details section
    st.divider()
    st.subheader("üîî Active Alerts & Key Issues")

    alerts = []

    # Check service level
    if not service_data.empty and 'on_time' in service_data.columns:
        on_time_pct = (service_data['on_time'].sum() / len(service_data) * 100)
        if on_time_pct < 90:
            alerts.append(("warning", f"Service level below target: {on_time_pct:.1f}% (Target: 95%)"))

    # Check backorders
    if not backorder_data.empty and 'days_on_backorder' in backorder_data.columns:
        old_backorders = len(backorder_data[backorder_data['days_on_backorder'] > 30])
        if old_backorders > 0:
            alerts.append(("warning", f"{old_backorders} backorders aged over 30 days"))

    # Check critical stock
    if not inventory_data.empty:
        if 'stock_out_risk' in inventory_data.columns:
            critical_skus = len(inventory_data[inventory_data['stock_out_risk'] == 'Critical'])
        elif 'dio' in inventory_data.columns:
            critical_skus = len(inventory_data[inventory_data['dio'] < 30])
        else:
            critical_skus = 0

        if critical_skus > 0:
            alerts.append(("error", f"{critical_skus} SKUs at critical stock-out risk (DIO < 30 days)"))

    if not alerts:
        st.success("‚úì All metrics within normal range")
    else:
        for alert_type, message in alerts:
            render_info_box(message, type=alert_type)

    # Details sections
    st.divider()

    # Top Backorder Customers
    if not backorder_data.empty and 'customer_name' in backorder_data.columns and 'backorder_qty' in backorder_data.columns:
        with st.expander("üìã Top 10 Backorder Customers", expanded=False):
            customer_backorders = backorder_data.groupby('customer_name')['backorder_qty'].agg(['sum', 'count']).reset_index()
            customer_backorders.columns = ['Customer', 'Total Units', 'Order Lines']
            customer_backorders = customer_backorders.sort_values('Total Units', ascending=False).head(10)

            st.dataframe(
                customer_backorders,
                hide_index=True,
                use_container_width=True
            )

    # Critical Stock SKUs
    if not inventory_data.empty and critical_skus > 0:
        with st.expander(f"‚ö†Ô∏è Critical Stock SKUs ({critical_skus} items)", expanded=False):
            if 'stock_out_risk' in inventory_data.columns:
                critical_items = inventory_data[inventory_data['stock_out_risk'] == 'Critical']
            elif 'dio' in inventory_data.columns:
                critical_items = inventory_data[inventory_data['dio'] < 30]
            else:
                critical_items = pd.DataFrame()

            if not critical_items.empty:
                display_cols = []
                if 'sku' in critical_items.columns:
                    display_cols.append('sku')
                if 'category' in critical_items.columns:
                    display_cols.append('category')
                if 'on_hand_qty' in critical_items.columns:
                    display_cols.append('on_hand_qty')
                if 'dio' in critical_items.columns:
                    display_cols.append('dio')

                if display_cols:
                    critical_display = critical_items[display_cols].head(20).copy()
                    critical_display.columns = [col.replace('_', ' ').title() for col in critical_display.columns]
                    st.dataframe(
                        critical_display,
                        hide_index=True,
                        use_container_width=True
                    )
